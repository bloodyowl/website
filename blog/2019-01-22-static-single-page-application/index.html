<!DOCTYPE html><html lang="en"><head><title data-react-helmet="true">Static single page application</title><meta data-react-helmet="true" name="description" value="Front-end developer and designer. ReasonML, ReasonReact, ReactJS."/><meta data-react-helmet="true" charset="UTF-8"/><meta data-react-helmet="true" content="w75-P-0ywXWkyZvYPbkSM3VSM2hny25UrfeiWJt3B1k" name="google-site-verification"/><meta data-react-helmet="true" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" name="viewport"/><meta data-react-helmet="true" content="summary_large_image" name="twitter:card"/><meta data-react-helmet="true" content="website" property="og:type"/><meta data-react-helmet="true" content="https://bloodyowl.io/public/assets/images/share.jpg" property="og:image"/><meta data-react-helmet="true" content="https://bloodyowl.io/public/assets/images/share.jpg" name="twitter:image"/><meta data-react-helmet="true" content="@bloodyowl" name="twitter:site"/><meta data-react-helmet="true" content="1500" property="og:image:width"/><meta data-react-helmet="true" content="777" property="og:image:height"/><link data-react-helmet="true" href="/public/assets/images/favicon.png" rel="shortcut icon"/><link data-react-helmet="true" href="https://bloodyowl.io/blog/2019-01-22-static-single-page-application/" rel="canonical"/><style data-react-helmet="true" >@import url("//hello.myfonts.net/count/3cae5f")</style><script data-react-helmet="true" >window.beOpAsyncInit = function() {
        BeOpSDK.init({
          account: "556e1d2772a6b60100844051"
        });
        BeOpSDK.watch();
      };</script><script data-react-helmet="true" async="true" src="https://widget.beop.io/sdk.js"></script><script>window.PAGES_BOOT_MODE="hydrate";</script></head><div id="root"><style data-emotion="rpcss 13ah45v 1e19svg 956oyo">@-webkit-keyframes animation-13ah45v{50%{opacity:0.5;}}@keyframes animation-13ah45v{50%{opacity:0.5;}}@font-face{font-family:HelveticaNowDisplay;src:url("/public/assets/webfonts/regular.woff2"),url("/public/assets/webfonts/regular.woff");font-style:normal;font-weight:400;font-display:swap;}@font-face{font-family:HelveticaNowDisplay;src:url("/public/assets/webfonts/bold.woff2"),url("/public/assets/webfonts/bold.woff");font-style:normal;font-weight:700;font-display:swap;}body{background-color:#65E197;font-family:HelveticaNowDisplay,"Helvetica Neue",Helvetica,Arial,sans-serif;overflow-x:hidden;padding:10px;}#root{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}html{color:#111;font-size:1em;line-height:1.4;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;}*,*:before,*:after{box-sizing:border-box;}pre,.hljs{color:#abb2bf;background:#282c34;}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic;}.hljs-doctag,.hljs-keyword,.hljs-formula{color:#c678dd;}.hljs-section,.hljs-name,.hljs-selector-tag,.hljs-deletion,.hljs-subst{color:#e06c75;}.hljs-literal{color:#56b6c2;}.hljs-string,.hljs-regexp,.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string{color:#98c379;}.hljs-attr,.hljs-variable,.hljs-template-variable,.hljs-type,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-number{color:#d19a66;}.hljs-symbol,.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-title{color:#61aeee;}.hljs-built_in,.hljs-title.class_,.hljs-class .hljs-title{color:#e6c07b;}.hljs-emphasis{font-style:italic;}.hljs-strong{font-weight:bold;}.hljs-link{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion="rpcss bibabd">.rpcss-bibabd{position:relative;min-height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;background-color:#fff;border-radius:20px;width:100%;max-width:1200px;padding-top:10px;margin:0 auto;box-shadow:0 20px 20px -10px rgba(0, 0, 0, 0.3);}</style><div class="rpcss-bibabd"><style data-emotion="rpcss 1sdq6nl">.rpcss-1sdq6nl{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;font-size:18px;padding:0 env(safe-area-inset-right) 0 env(safe-area-inset-left);}</style><div class="rpcss-1sdq6nl"><style data-emotion="rpcss qq6n5i">.rpcss-qq6n5i{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;color:#111;-webkit-text-decoration:none;text-decoration:none;}</style><a class="rpcss-qq6n5i" href="/"><style data-emotion="rpcss 19jaiin">.rpcss-19jaiin{margin-right:10px;margin-left:20px;-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;}</style><svg class="rpcss-19jaiin" height="64" width="64" viewBox="0 0 228 228" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="m113.9 0 .1.3 37 9.7 20.7-8.5 14.2 21.9h-.2.1l-11.3 14a51 51 0 0 1 7.3 8.4c2 3.1 3.4 6.2 4.3 9.4l.1.5a245 245 0 0 1-3 21.4l.8.8c3.6 3.8 6.6 7.6 9 11.4 2.6 4.1 4.6 8.3 5.9 12.4l.1.5-3 10.9c-.9 17.1-4.2 34-9.9 50.6-6 17.3-14.4 33.6-24.8 48.7l-.8 1-16-1.5-12.7 14.5H95.5l-.6-.7a231 231 0 0 1-12.2-13.8l-16.1 1.6a207.1 207.1 0 0 1-25.7-49.8c-5.5-16-8.7-32.5-9.7-49.3l-.1-1.3-3.1-10.9a83 83 0 0 1 6.1-12.9c2.4-3.8 5.4-7.6 9-11.4l.7-.8A285 285 0 0 1 41 57.3l-.1-1.5c.8-3.4 2.3-6.7 4.4-10 2.1-3 4.6-6 7.3-8.5l-11.3-14 14-21.8L76.1 10l37-9.7V.1h.9l-.1-.1Z" fill="#65E197" fill-opacity=".1"></path><path d="m114 1.1 37 9.9 20.7-8.5 14.2 21.9-11.4 14a51 51 0 0 1 7.3 8.4c1.7 2.6 2.9 5.1 3.8 7.7l.2.6.2.6.1.5.1.5c-.7 7-1.6 13.7-2.8 20.4 0 1.3.3 1.5.5 1.7 3.7 3.9 6.7 7.7 9.1 11.5 2.2 3.4 4 6.9 5.2 10.3l.2.7.3.8.2.6.1.5-3 10.9c-.9 17.1-4.2 34-9.9 50.6-5.6 16-13.2 31.2-22.5 45.3l-.8 1.2-.8 1.1-.7 1.1-.8 1-16-1.5c-2.4 2.8-6.3 7.4-12 13.7l-.4.5-36.6.3-.6-.7-7.8-8.5-1.2-1.5-1.3-1.5-2-2.3-16 1.6a207 207 0 0 1-25.7-49.8c-5-14.6-8.2-29.8-9.4-45.2l-.1-1.4-.1-1.3-.1-1.4-.1-1.3-3.1-10.9a83 83 0 0 1 6.1-12.9c2.4-3.8 5.4-7.6 9-11.4-.2-4.6-.6-8.1-1-11.5l-.6-4.5-.2-1.5v-1l-.3-2.1-.1-1.5a32.5 32.5 0 0 1 8.5-15.2l.6-.7.7-.7 1.9-2-11.3-13.9 14-21.8L76.1 11l37-9.7.8-.2Zm68.3 82.1a312.7 312.7 0 0 1-.8 4 256 256 0 0 1-17.7 53.2 229.4 229.4 0 0 1-45.4 65.8l-.9.9-.9.9-1.1 1-14.6 14h29.4l1.6-1.7 1-1.1 1-1.1c13.4-15 25-31.6 34.6-49.3a317.9 317.9 0 0 0 25-61l.4-1.6.5-1.7.5-2-.5-1.3-.3-.8-.3-.8a49 49 0 0 0-10.2-16l-1.3-1.4Zm-137.6 0a66.3 66.3 0 0 0-7.1 9.3 37.1 37.1 0 0 0-5.1 11.9c6.3 22.7 15 44.6 26.2 65.3 9.4 17.6 20.9 34 34.2 48.8l1 1.2 2.4 2.6 14.3-14.2-2.4-2.4-.9-1-.9-.9a229.4 229.4 0 0 1-43-63.4 267.1 267.1 0 0 1-18.7-57.3Zm-10.7 43 8 27.8.5 2 .4 1.4A196.6 196.6 0 0 0 66.3 207l.8 1.2 1.5 2.2 11.2-1.1-3.3-4.2-1-1.4-1-1.4a263.5 263.5 0 0 1-27-45.7l-.9-2-.9-1.9L34 126.3Zm160.2-4.8-6.6 17-.8 1.8a305.3 305.3 0 0 1-14.7 31.4c-6.1 11.4-13 22-20.3 32l-1 1.4-3.3 4.2 11.2 1 1.5-2.2.7-1.1.9-1.3a201.5 201.5 0 0 0 22.7-48.5l.5-1.6 9.2-34Zm-13.5-57.6a168.3 168.3 0 0 1-20.9 21l-1.1.9-1.2 1-.5.3-3.4 2.6-1.1.8-1.1.9-1.2.8c-9.4 6.8-19.6 13-30.6 18.3l-1.4.7-2.5 1.2v91.1l4.4-4.6.9-1 .8-1a225.3 225.3 0 0 0 38.5-58.1 250.8 250.8 0 0 0 19.9-66l.2-1.5.3-7.4ZM45.5 62.5l1.3 8.2.2 1.4.2 1.5A256.5 256.5 0 0 0 67 138.7a225 225 0 0 0 39.3 59l1 1 4.3 4.7v-91l-2.5-1.3-1.4-.7-1.4-.7c-11.8-5.9-23-12.9-33.6-20.9l-1.2-.9-1.2-.9-.5-.4-1.2-1-1.1-.9-1-.9a168.6 168.6 0 0 1-21-21.3Zm97.2 15.1-23.3 28.9 10.7-6 1.4-1 1.5-.8c5.3-3.2 10.5-6.6 15.5-10.2l1.4-1 3.6-2.7-10.8-7.2Zm-58.1 0-10.8 7.1 3.6 2.7 1.4 1 1.3 1c5 3.5 10.2 6.9 15.6 10l1.5.9 10.7 6-23.3-28.7Zm31.1-13.9v41L137.9 77l-22.2-13.3Zm-4.1 0L89.3 77.1l22.3 27.5V63.7Zm60.5-22.2-14.4 17.7-.1 22.2 4.3-3.9 1-.8 1-1A165.5 165.5 0 0 0 182 56a21.5 21.5 0 0 0-.4-1c-.7-2-1.6-3.9-3-5.9-1.6-2.5-3.8-5-6.4-7.5Zm-117 0c-2.6 2.5-4.8 5-6.4 7.5a28 28 0 0 0-3.4 7 80.9 80.9 0 0 0 .7.9c5.7 7.2 11.8 13.8 18.2 19.7l1 .9 4.4 4-.1-22.3-14.4-17.7Zm18.4 22.7.1 15.8 8.3-5.4-8.4-10.4Zm80 0-8.3 10.4 8.3 5.4V64.2ZM51.6 30.8l17.8 21.8 6.8 8.5L86.6 74l20.8-12.5-55.8-30.7Zm123.9 0-55.8 30.7L140.4 74l10.5-13 6.7-8.2 17.9-22Zm-62-25.5L46 23.1l67.5 37.3 67.6-37.3-67.6-17.8Zm56.7 2.1-12.8 5.3 19.5 5.3-6.7-10.6Zm-113.3 0-6.7 10.5 19.5-5.2-12.8-5.3Z" fill="#000" fill-rule="nonzero"></path><path d="M43.1 89.8c4.1 17.8 10 35.2 17.6 51.8 11 24.2 26 46.2 44.5 65.3l1 1-9.8 10a251.3 251.3 0 0 1-35-49.6 317 317 0 0 1-26-64.4 41 41 0 0 1 7.7-14Zm135.1 76.6a198.4 198.4 0 0 1-19.7 38.8l-.8 1.2-.5.7-4-.4 1-1.3c7.1-9.7 13.7-20 19.7-30.8l.8-1.6 3.1-5.9.4-.7ZM118.7 69l14.7 8.8-14.7 18.4V69Zm24.6 12.6 5 3.3c-5.2 3.8-10.4 7.3-15.7 10.5l-.8.5 11.5-14.3Zm29-35.6a33.4 33.4 0 0 1 6.2 9.3c-5.8 7.5-12 14-18.6 20l.7-.6.1-14.4L172.3 46Zm-8.8-5.1-8.2 10-6.7 8.2-8.9 11-14-8.5L163.5 41ZM58 11l2.3 1-3.5 1 1.2-2Zm119.1 61.2-.2 1.5a247.5 247.5 0 0 1-19.4 63.7 222.3 222.3 0 0 1-39.7 59.2l.8-.9v-81.6l.8-.4a213.8 213.8 0 0 0 34.8-21l1.1-.8 3.4-2.6.6-.5 1.2-1c5.8-4.8 11.4-10 16.6-15.6Z" fill="#65E197"></path><path d="m73.5 64.2 8.4 10.4-8.3 5.4zM153.5 64.2V80l-8.3-5.4z" fill="#FFF"></path></g></svg><style data-emotion="rpcss 1jwoke4">.rpcss-1jwoke4{padding:20px 20px 23px 0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;line-height:1.2;}</style><div aria-level="1" class="rpcss-1jwoke4" role="heading"><style data-emotion="rpcss a6owh4">.rpcss-a6owh4{font-weight:bold;margin-right:10px;white-space:nowrap;}</style><div class="rpcss-a6owh4">Matthias Le Brun</div><div>@bloodyowl</div></div></a><style data-emotion="rpcss u4p24i">.rpcss-u4p24i{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="rpcss-u4p24i"><style data-emotion="rpcss 1xib33k">.rpcss-1xib33k{padding:20px 20px 23px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-text-decoration:none;text-decoration:none;color:#111;text-align:center;scroll-snap-align:start;font-size:20px;font-weight:bold;}</style><a class="rpcss-1xib33k" href="/blog/">→ Blog</a></div></div><style data-emotion="rpcss n63pef">.rpcss-n63pef{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);}</style><div class="rpcss-n63pef"><style data-emotion="rpcss n0fndg">.rpcss-n0fndg{max-width:640px;margin:20px auto;padding:0 10px;width:100%;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="rpcss-n0fndg"><style data-emotion="rpcss apovzu">.rpcss-apovzu{margin:0;font-size:48px;margin-top:50px;margin-bottom:10px;line-height:1.15;}</style><h1 class="rpcss-apovzu">Static single page application</h1><style data-emotion="rpcss 12xm3b2">.rpcss-12xm3b2{font-size:14px;opacity:0.5;margin-bottom:50px;}</style><div class="rpcss-12xm3b2">2019/01/22</div><style data-emotion="rpcss 1qdwpun">.rpcss-1qdwpun{margin-top:40px;font-size:20px;line-height:1.5;}.rpcss-1qdwpun a{color:#135EFF;}.rpcss-1qdwpun a:hover{color:#13A3FF;}.rpcss-1qdwpun img{max-width:100%;height:auto;opacity:0;-webkit-transition:300ms ease-out opacity;transition:300ms ease-out opacity;}.rpcss-1qdwpun pre{padding:10px 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;font-size:16px;border-radius:8px;}.rpcss-1qdwpun code{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:0.85em;line-height:1;}.rpcss-1qdwpun table{width:100%;text-align:center;}.rpcss-1qdwpun table thead th{background-color:#FFF;padding:10px 0;}.rpcss-1qdwpun blockquote{opacity:0.6;border-left:4px solid #111;margin:0;padding:0 20px;}.rpcss-1qdwpun hr{border-color:rgba(0, 0, 0, 0.1);}</style><div class="rpcss-1qdwpun" role="article"><p>As you can see from the URL, this little website is hosted on GitHub pages, meaning it can only be static.</p>
<p>The approach I chose here was to build it like a single page application that I'd render at build time.</p>
<p>This approach gives the best of both worlds :</p>
<ul>
<li>an familiar and powerful way to build UIs</li>
<li>a fast initial load</li>
<li>a fast navigation after the first load: any transition that occur after will only query the smallest amount data it possibly can in order to render the next route</li>
</ul>
<h2>Getting the data for the blog</h2>
<p>I have a blog direction with markdown files. In order to get them, I made a few bindings to glob, remarkable and front-matter so that I can transform posts into two kinds of records:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">module</span> <span class="hljs-module-identifier">PostShallow</span> = {
  <span class="hljs-keyword">type</span> t = {
    title: string,
    date: string,
    slug: string,
  };
};

<span class="hljs-keyword">module</span> <span class="hljs-module-identifier">Post</span> = {
  <span class="hljs-keyword">type</span> t = {
    title: string,
    date: string,
    body: string,
  };
};
</code></pre>
<p><code>postShallow</code> will be used in listings, and <code>post</code> for the detail page.</p>
<h2>The routing</h2>
<p>Given I use ReasonReact, I use the builtin Router solution. At first it was in my <code>App</code> component state.</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">let</span> component = <span class="hljs-module-identifier">React</span>.reducerComponent(<span class="hljs-string">&quot;App&quot;</span>);

<span class="hljs-keyword">let</span> make = (_) =&gt; {
  <span class="hljs-operator">...</span>component,
  initialState: () =&gt; <span class="hljs-module-identifier">React</span>.<span class="hljs-module-identifier">Router</span>.dangerouslyGetInitialUrl(),
  reducer: (action, _state) =&gt;
    <span class="hljs-keyword">switch</span> action {
    | <span class="hljs-constructor">SetRoute</span>(url) =&gt; <span class="hljs-constructor">Update</span>(url)
    },
  <span class="hljs-comment">/* ... */</span>
}
</code></pre>
<p>In order to make it statically renderable, I moved it from <code>state</code> to props. I now have a <code>Main</code> module with a recursive render function that calls itself whenever there's a URL change.</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">let</span> <span class="hljs-keyword">rec</span> render = (~url=<span class="hljs-module-identifier">React</span>.<span class="hljs-module-identifier">Router</span>.dangerouslyGetInitialUrl(), ()) =&gt; {
  <span class="hljs-comment">/* render logic here */</span>
  <span class="hljs-keyword">let</span> watcherId = ref(<span class="hljs-constructor">None</span>);
  watcherId <span class="hljs-operator">:=</span>
    <span class="hljs-constructor">Some</span>(
      <span class="hljs-module-identifier">React</span>.<span class="hljs-module-identifier">Router</span>.watchUrl(url =&gt; {
        (watcherId<span class="hljs-operator">^</span>)
        <span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Option</span>.map(watcherId =&gt; <span class="hljs-module-identifier">React</span>.<span class="hljs-module-identifier">Router</span>.unwatchUrl(watcherId))
        <span class="hljs-operator">-&gt;</span>ignore;
        render(~url, ());
      }),
    );
}
</code></pre>
<p>This render function will only be used on the client. At build time we'll call App directly. An important thing to remember here is that your CSS reset needs to be in App, otherwise it'll only be called once the client boots.</p>
<h2>The data</h2>
<p>Initially I planned to put data in route component states themselves, but this would've required extra steps in serialisation I didn't want to take for such a simple project.</p>
<p>I simply moved the data up the <code>App</code> component state, and passed two things to the routes:</p>
<ul>
<li>the data they need</li>
<li>a callback to set this data when received</li>
</ul>
<p>The app state actually looks quite simple:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">type</span> state = {
  posts: <span class="hljs-module-identifier">Map</span>.<span class="hljs-module-identifier">String</span>.t(<span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Post</span>.t, <span class="hljs-module-identifier">Errors</span>.t))),
  postList: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(array(<span class="hljs-module-identifier">PostShallow</span>.t), <span class="hljs-module-identifier">Errors</span>.t)),
};
</code></pre>
<p>This way, only App is changed when the store shape changes. I could've passed the initial data so that routes can hydrate their initial state, but that would defeat the purpose for an efficient loading experience: it would've refreshed the data every time the route mounts instead of keeping it.</p>
<h2>The styles</h2>
<p>I use <a href="https://github.com/SentiaAnalytics/bs-css">bs-css</a>, which recently switched to emotion. It simply required to write a little binding to emotion-server in order to render styles on the server.</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">module</span> <span class="hljs-module-identifier">Emotion</span> = {
  <span class="hljs-attribute">[@bs.module &quot;emotion-server&quot;]</span>
  <span class="hljs-keyword">external</span> renderStylesToString: string =&gt; string = <span class="hljs-string">&quot;renderStylesToString&quot;</span>;
};
</code></pre>
<h2>Hydration</h2>
<p>For the hydration, I just check if my root element is empty and hydrate instead of render if it's not.</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">let</span> markup =
  <span class="hljs-module-identifier">DomRe</span>.(
    <span class="hljs-module-identifier">Document</span>.getElementById(<span class="hljs-string">&quot;root&quot;</span>, document)
    <span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Option</span>.map(<span class="hljs-module-identifier">Element</span>.innerHTML)
    <span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Option</span>.flatMap(item =&gt; item <span class="hljs-operator">==</span> <span class="hljs-string">&quot;&quot;</span> ? <span class="hljs-constructor">None</span> : <span class="hljs-constructor">Some</span>(item))
  );
  
<span class="hljs-keyword">switch</span> (markup) {
| <span class="hljs-constructor">Some</span>(_) =&gt;
  <span class="hljs-module-identifier">ReactDOMRe</span>.hydrateToElementWithId(&lt;<span class="hljs-module-identifier">App</span> url ?initialData /&gt;, <span class="hljs-string">&quot;root&quot;</span>)
| <span class="hljs-constructor">None</span> =&gt;
  <span class="hljs-module-identifier">ReactDOMRe</span>.renderToElementWithId(&lt;<span class="hljs-module-identifier">App</span> url ?initialData /&gt;, <span class="hljs-string">&quot;root&quot;</span>)
};
</code></pre>
<h2>Prerender all the pages</h2>
<p>First, I render a dummy HTML file using html-webpack-plugin, it'll be used as a template for all the pages. The plugin will just add the right app JS.</p>
<p>I just list all pages with their URLs and the App state they need to render, and replace elements from the template with the rendered HTML, title and initial data and write files in the build directory.</p>
<pre><code class="hljs language-reason"><span class="hljs-module-identifier">Node</span>.<span class="hljs-module-identifier">Fs</span>.writeFileAsUtf8Sync(
  <span class="hljs-string">&quot;./build/&quot;</span> <span class="hljs-operator">++</span> <span class="hljs-module-identifier">String</span>.concat(<span class="hljs-string">&quot;/&quot;</span>, path) <span class="hljs-operator">++</span> <span class="hljs-string">&quot;/index.html&quot;</span>,
  index
  <span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Js</span>.<span class="hljs-module-identifier">String</span>.replace(
      <span class="hljs-string">{|&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;|}</span>,
      <span class="hljs-string">{j|&lt;div id=&quot;root&quot;&gt;$prerendered&lt;/div&gt;&lt;script id=&quot;data&quot;&gt;window.initialData = $data&lt;/script&gt;|j}</span>,
      _,
    )
  <span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Js</span>.<span class="hljs-module-identifier">String</span>.replace(
      <span class="hljs-string">{|&lt;title&gt;TITLE&lt;/title&gt;|}</span>,
      <span class="hljs-string">{j|&lt;title&gt;$title | @bloodyowl&lt;/title&gt;&lt;meta property=&quot;og:title&quot; content=&quot;$title | @bloodyowl&quot; /&gt;|j}</span>,
      _,
    ),
);
</code></pre>
</div><style data-emotion="rpcss jd8mf7">.rpcss-jd8mf7{max-width:640px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:spaceBetween;-ms-flex-pack:spaceBetween;-webkit-justify-content:spaceBetween;justify-content:spaceBetween;margin:20px 0;padding:20px;background-color:#FFF;border-radius:10px;box-shadow:0 15px 15px 5px rgba(0, 0, 0, 0.2),0 0 0 1px rgba(0, 0, 0, 0.1);}@media (max-width: 540px){.rpcss-jd8mf7{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-jd8mf7"><style data-emotion="rpcss 1p761yt">.rpcss-1p761yt{font-weight:900;font-size:18px;}</style><div class="rpcss-1p761yt">Liked this article?</div><style data-emotion="rpcss klacsp">.rpcss-klacsp{width:0;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-klacsp"></div><style data-emotion="rpcss mumwm1">.rpcss-mumwm1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}@media (max-width: 540px){.rpcss-mumwm1{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-mumwm1"><style data-emotion="rpcss 14isay4">.rpcss-14isay4{background-color:#00aced;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:900;}.rpcss-14isay4:active{opacity:0.5;}</style><a class="rpcss-14isay4" href="https://www.twitter.com/intent/tweet?text=Static%20single%20page%20application%20from%20%40bloodyowl%20https%3A%2F%2Fbloodyowl.io%2Fblog%2F2019-01-22-static-single-page-application" target="_blank">→ Share it on Twitter</a><style data-emotion="rpcss 4cf197">.rpcss-4cf197{width:10px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-4cf197"></div><style data-emotion="rpcss v8vdfl">.rpcss-v8vdfl{background-color:#ea4aaa;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:900;}.rpcss-v8vdfl:active{opacity:0.5;}</style><a class="rpcss-v8vdfl" href="https://github.com/sponsors/bloodyowl" rel="noopener" target="_blank">→ Sponsor me on GitHub</a></div></div><style data-emotion="rpcss sq4ju6">.rpcss-sq4ju6{padding:10px 0;}</style><div class="rpcss-sq4ju6"><div class="BeOpWidget"></div></div></div></div><style data-emotion="rpcss 1s8zdpq">.rpcss-1s8zdpq{color:#111;text-align:center;padding:20px;font-size:14px;}</style><div class="rpcss-1s8zdpq"><div>Copyright 2021 - Matthias Le Brun</div><div><style data-emotion="rpcss 1tzeee1">.rpcss-1tzeee1{opacity:0.5;}</style><span class="rpcss-1tzeee1">Do you like the content? </span><style data-emotion="rpcss 1d5fxl9">.rpcss-1d5fxl9{color:#EC8AC5;}.rpcss-1d5fxl9:hover{color:#F9BDE1;}</style><a class="rpcss-1d5fxl9" href="https://github.com/sponsors/bloodyowl"> Sponsor me on GitHub</a></div></div></div></div><script id="initialData" type="text/data">{"lists":{"RE_PRIVATE_NONE":true},"items":{"k":"blog","v":{"k":"2019-01-22-static-single-page-application","v":{"_0":{"TAG":0,"_0":{"slug":"2019-01-22-static-single-page-application","filename":"2019-01-22-static-single-page-application","title":"Static single page application","date":"Tue, 22 Jan 2019 00:00:00 GMT","draft":false,"meta":{"date":"2019-01-22T00:00:00.000Z","title":"Static single page application"},"body":"<p>As you can see from the URL, this little website is hosted on GitHub pages, meaning it can only be static.</p>\n<p>The approach I chose here was to build it like a single page application that I'd render at build time.</p>\n<p>This approach gives the best of both worlds :</p>\n<ul>\n<li>an familiar and powerful way to build UIs</li>\n<li>a fast initial load</li>\n<li>a fast navigation after the first load: any transition that occur after will only query the smallest amount data it possibly can in order to render the next route</li>\n</ul>\n<h2>Getting the data for the blog</h2>\n<p>I have a blog direction with markdown files. In order to get them, I made a few bindings to glob, remarkable and front-matter so that I can transform posts into two kinds of records:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">module</span> <span class=\"hljs-module-identifier\">PostShallow</span> = {\n  <span class=\"hljs-keyword\">type</span> t = {\n    title: string,\n    date: string,\n    slug: string,\n  };\n};\n\n<span class=\"hljs-keyword\">module</span> <span class=\"hljs-module-identifier\">Post</span> = {\n  <span class=\"hljs-keyword\">type</span> t = {\n    title: string,\n    date: string,\n    body: string,\n  };\n};\n</code></pre>\n<p><code>postShallow</code> will be used in listings, and <code>post</code> for the detail page.</p>\n<h2>The routing</h2>\n<p>Given I use ReasonReact, I use the builtin Router solution. At first it was in my <code>App</code> component state.</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">let</span> component = <span class=\"hljs-module-identifier\">React</span>.reducerComponent(<span class=\"hljs-string\">&quot;App&quot;</span>);\n\n<span class=\"hljs-keyword\">let</span> make = (_) =&gt; {\n  <span class=\"hljs-operator\">...</span>component,\n  initialState: () =&gt; <span class=\"hljs-module-identifier\">React</span>.<span class=\"hljs-module-identifier\">Router</span>.dangerouslyGetInitialUrl(),\n  reducer: (action, _state) =&gt;\n    <span class=\"hljs-keyword\">switch</span> action {\n    | <span class=\"hljs-constructor\">SetRoute</span>(url) =&gt; <span class=\"hljs-constructor\">Update</span>(url)\n    },\n  <span class=\"hljs-comment\">/* ... */</span>\n}\n</code></pre>\n<p>In order to make it statically renderable, I moved it from <code>state</code> to props. I now have a <code>Main</code> module with a recursive render function that calls itself whenever there's a URL change.</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">let</span> <span class=\"hljs-keyword\">rec</span> render = (~url=<span class=\"hljs-module-identifier\">React</span>.<span class=\"hljs-module-identifier\">Router</span>.dangerouslyGetInitialUrl(), ()) =&gt; {\n  <span class=\"hljs-comment\">/* render logic here */</span>\n  <span class=\"hljs-keyword\">let</span> watcherId = ref(<span class=\"hljs-constructor\">None</span>);\n  watcherId <span class=\"hljs-operator\">:=</span>\n    <span class=\"hljs-constructor\">Some</span>(\n      <span class=\"hljs-module-identifier\">React</span>.<span class=\"hljs-module-identifier\">Router</span>.watchUrl(url =&gt; {\n        (watcherId<span class=\"hljs-operator\">^</span>)\n        <span class=\"hljs-operator\">-&gt;</span><span class=\"hljs-module-identifier\">Option</span>.map(watcherId =&gt; <span class=\"hljs-module-identifier\">React</span>.<span class=\"hljs-module-identifier\">Router</span>.unwatchUrl(watcherId))\n        <span class=\"hljs-operator\">-&gt;</span>ignore;\n        render(~url, ());\n      }),\n    );\n}\n</code></pre>\n<p>This render function will only be used on the client. At build time we'll call App directly. An important thing to remember here is that your CSS reset needs to be in App, otherwise it'll only be called once the client boots.</p>\n<h2>The data</h2>\n<p>Initially I planned to put data in route component states themselves, but this would've required extra steps in serialisation I didn't want to take for such a simple project.</p>\n<p>I simply moved the data up the <code>App</code> component state, and passed two things to the routes:</p>\n<ul>\n<li>the data they need</li>\n<li>a callback to set this data when received</li>\n</ul>\n<p>The app state actually looks quite simple:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">type</span> state = {\n  posts: <span class=\"hljs-module-identifier\">Map</span>.<span class=\"hljs-module-identifier\">String</span>.t(<span class=\"hljs-module-identifier\">RequestStatus</span>.t(<span class=\"hljs-module-identifier\">Result</span>.t(<span class=\"hljs-module-identifier\">Post</span>.t, <span class=\"hljs-module-identifier\">Errors</span>.t))),\n  postList: <span class=\"hljs-module-identifier\">RequestStatus</span>.t(<span class=\"hljs-module-identifier\">Result</span>.t(array(<span class=\"hljs-module-identifier\">PostShallow</span>.t), <span class=\"hljs-module-identifier\">Errors</span>.t)),\n};\n</code></pre>\n<p>This way, only App is changed when the store shape changes. I could've passed the initial data so that routes can hydrate their initial state, but that would defeat the purpose for an efficient loading experience: it would've refreshed the data every time the route mounts instead of keeping it.</p>\n<h2>The styles</h2>\n<p>I use <a href=\"https://github.com/SentiaAnalytics/bs-css\">bs-css</a>, which recently switched to emotion. It simply required to write a little binding to emotion-server in order to render styles on the server.</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">module</span> <span class=\"hljs-module-identifier\">Emotion</span> = {\n  <span class=\"hljs-attribute\">[@bs.module &quot;emotion-server&quot;]</span>\n  <span class=\"hljs-keyword\">external</span> renderStylesToString: string =&gt; string = <span class=\"hljs-string\">&quot;renderStylesToString&quot;</span>;\n};\n</code></pre>\n<h2>Hydration</h2>\n<p>For the hydration, I just check if my root element is empty and hydrate instead of render if it's not.</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">let</span> markup =\n  <span class=\"hljs-module-identifier\">DomRe</span>.(\n    <span class=\"hljs-module-identifier\">Document</span>.getElementById(<span class=\"hljs-string\">&quot;root&quot;</span>, document)\n    <span class=\"hljs-operator\">-&gt;</span><span class=\"hljs-module-identifier\">Option</span>.map(<span class=\"hljs-module-identifier\">Element</span>.innerHTML)\n    <span class=\"hljs-operator\">-&gt;</span><span class=\"hljs-module-identifier\">Option</span>.flatMap(item =&gt; item <span class=\"hljs-operator\">==</span> <span class=\"hljs-string\">&quot;&quot;</span> ? <span class=\"hljs-constructor\">None</span> : <span class=\"hljs-constructor\">Some</span>(item))\n  );\n  \n<span class=\"hljs-keyword\">switch</span> (markup) {\n| <span class=\"hljs-constructor\">Some</span>(_) =&gt;\n  <span class=\"hljs-module-identifier\">ReactDOMRe</span>.hydrateToElementWithId(&lt;<span class=\"hljs-module-identifier\">App</span> url ?initialData /&gt;, <span class=\"hljs-string\">&quot;root&quot;</span>)\n| <span class=\"hljs-constructor\">None</span> =&gt;\n  <span class=\"hljs-module-identifier\">ReactDOMRe</span>.renderToElementWithId(&lt;<span class=\"hljs-module-identifier\">App</span> url ?initialData /&gt;, <span class=\"hljs-string\">&quot;root&quot;</span>)\n};\n</code></pre>\n<h2>Prerender all the pages</h2>\n<p>First, I render a dummy HTML file using html-webpack-plugin, it'll be used as a template for all the pages. The plugin will just add the right app JS.</p>\n<p>I just list all pages with their URLs and the App state they need to render, and replace elements from the template with the rendered HTML, title and initial data and write files in the build directory.</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-module-identifier\">Node</span>.<span class=\"hljs-module-identifier\">Fs</span>.writeFileAsUtf8Sync(\n  <span class=\"hljs-string\">&quot;./build/&quot;</span> <span class=\"hljs-operator\">++</span> <span class=\"hljs-module-identifier\">String</span>.concat(<span class=\"hljs-string\">&quot;/&quot;</span>, path) <span class=\"hljs-operator\">++</span> <span class=\"hljs-string\">&quot;/index.html&quot;</span>,\n  index\n  <span class=\"hljs-operator\">-&gt;</span><span class=\"hljs-module-identifier\">Js</span>.<span class=\"hljs-module-identifier\">String</span>.replace(\n      <span class=\"hljs-string\">{|&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;|}</span>,\n      <span class=\"hljs-string\">{j|&lt;div id=&quot;root&quot;&gt;$prerendered&lt;/div&gt;&lt;script id=&quot;data&quot;&gt;window.initialData = $data&lt;/script&gt;|j}</span>,\n      _,\n    )\n  <span class=\"hljs-operator\">-&gt;</span><span class=\"hljs-module-identifier\">Js</span>.<span class=\"hljs-module-identifier\">String</span>.replace(\n      <span class=\"hljs-string\">{|&lt;title&gt;TITLE&lt;/title&gt;|}</span>,\n      <span class=\"hljs-string\">{j|&lt;title&gt;$title | @bloodyowl&lt;/title&gt;&lt;meta property=&quot;og:title&quot; content=&quot;$title | @bloodyowl&quot; /&gt;|j}</span>,\n      _,\n    ),\n);\n</code></pre>\n"}}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"listsRequests":{"data":{"RE_PRIVATE_NONE":true}},"itemsRequests":{"data":{"RE_PRIVATE_NONE":true}}}</script><head><script defer="defer" src="/public/main.4809f57663274e5dc3ec.js"></script></head></html>