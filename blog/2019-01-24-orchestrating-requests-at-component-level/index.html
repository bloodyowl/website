<!DOCTYPE html><html lang="en"><head><title data-react-helmet="true">Orchestrating requests at component level</title><meta data-react-helmet="true" name="description" value="Front-end developer and designer. ReasonML, ReasonReact, ReactJS."/><meta data-react-helmet="true" charset="UTF-8"/><meta data-react-helmet="true" content="w75-P-0ywXWkyZvYPbkSM3VSM2hny25UrfeiWJt3B1k" name="google-site-verification"/><meta data-react-helmet="true" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" name="viewport"/><meta data-react-helmet="true" content="summary_large_image" name="twitter:card"/><meta data-react-helmet="true" content="website" property="og:type"/><meta data-react-helmet="true" content="https://bloodyowl.io/public/assets/images/share.jpg" property="og:image"/><meta data-react-helmet="true" content="https://bloodyowl.io/public/assets/images/share.jpg" name="twitter:image"/><meta data-react-helmet="true" content="@bloodyowl" name="twitter:site"/><meta data-react-helmet="true" content="1500" property="og:image:width"/><meta data-react-helmet="true" content="777" property="og:image:height"/><link data-react-helmet="true" href="/public/assets/images/favicon.png" rel="shortcut icon"/><link data-react-helmet="true" href="https://bloodyowl.io/blog/2019-01-24-orchestrating-requests-at-component-level/" rel="canonical"/><style data-react-helmet="true" >@import url("//hello.myfonts.net/count/3cae5f")</style><script>window.PAGES_BOOT_MODE="hydrate";</script></head><div id="root"><style data-emotion="rpcss 13ah45v ab7sxj 1hjsrhi 28v1b4 zx73cm">@-webkit-keyframes animation-13ah45v{50%{opacity:0.5;}}@keyframes animation-13ah45v{50%{opacity:0.5;}}@-webkit-keyframes animation-ab7sxj{from{-webkit-transform:scaleX(0);-moz-transform:scaleX(0);-ms-transform:scaleX(0);transform:scaleX(0);}}@keyframes animation-ab7sxj{from{-webkit-transform:scaleX(0);-moz-transform:scaleX(0);-ms-transform:scaleX(0);transform:scaleX(0);}}@font-face{font-family:HelveticaNowDisplay;src:url("/public/assets/webfonts/regular.woff2"),url("/public/assets/webfonts/regular.woff");font-style:normal;font-weight:400;font-display:swap;}@font-face{font-family:HelveticaNowDisplay;src:url("/public/assets/webfonts/bold.woff2"),url("/public/assets/webfonts/bold.woff");font-style:normal;font-weight:700;font-display:swap;}body{font-family:HelveticaNowDisplay,"Helvetica Neue",Helvetica,Arial,sans-serif;margin:0;padding:0;}*,*::before,*::after{box-sizing:border-box;}a:active,button:active{opacity:0.5;}pre,.hljs{color:#adbac7;background:#22272e;}.hljs-doctag,.hljs-keyword,.hljs-meta .hljs-keyword,.hljs-template-tag,.hljs-template-variable,.hljs-type,.hljs-variable.language_{color:#f47067;}.hljs-title,.hljs-title.class_,.hljs-title.class_.inherited__,.hljs-title.function_{color:#dcbdfb;}.hljs-attr,.hljs-attribute,.hljs-literal,.hljs-meta,.hljs-number,.hljs-operator,.hljs-variable,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id{color:#6cb6ff;}.hljs-regexp,.hljs-string,.hljs-meta .hljs-string{color:#96d0ff;}.hljs-built_in,.hljs-symbol{color:#f69d50;}.hljs-comment,.hljs-code,.hljs-formula{color:#768390;}.hljs-name,.hljs-quote,.hljs-selector-tag,.hljs-selector-pseudo{color:#8ddb8c;}.hljs-subst{color:#adbac7;}.hljs-section{color:#316dca;font-weight:bold;}.hljs-bullet{color:#eac55f;}.hljs-emphasis{color:#adbac7;font-style:italic;}.hljs-strong{color:#adbac7;font-weight:bold;}.hljs-addition{color:#b4f1b4;background-color:#1b4721;}.hljs-deletion{color:#ffd8d3;background-color:#78191b;}@-webkit-keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}@keyframes animation-zx73cm{from{opacity:0;-webkit-transform:translateY(20px);-moz-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px);}}</style><div><style data-emotion="rpcss 16zgwmd">.rpcss-16zgwmd{width:100%;margin:0 auto;padding:10px;max-width:1024px;position:relative;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="rpcss-16zgwmd"><style data-emotion="rpcss ynyn7j">.rpcss-ynyn7j{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;min-height:50vh;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;padding:20px 0;}@media (max-width: 600px){.rpcss-ynyn7j{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}}</style><header class="rpcss-ynyn7j"><style data-emotion="rpcss 1kjoxl2">.rpcss-1kjoxl2{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;-webkit-text-decoration:none;text-decoration:none;color:inherit;}@media (max-width: 600px){.rpcss-1kjoxl2{-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;text-align:center;}}</style><a class="rpcss-1kjoxl2" href="/"><style data-emotion="rpcss 15splxt">.rpcss-15splxt{width:10%;min-width:80px;}</style><div class="rpcss-15splxt"><style data-emotion="rpcss 1en06ca">.rpcss-1en06ca{padding-bottom:100%;position:relative;}</style><div class="rpcss-1en06ca"><style data-emotion="rpcss 1asitu4">.rpcss-1asitu4{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;object-position:50% 50%;}</style><img class="rpcss-1asitu4" alt="" src="/public/assets/images/logo.svg"/></div></div><style data-emotion="rpcss klacsp">.rpcss-klacsp{width:0;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-klacsp"></div><style data-emotion="rpcss 8yb3q0">.rpcss-8yb3q0{margin:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;font-weight:normal;font-size:1.25rem;line-height:1.2;}</style><h1 class="rpcss-8yb3q0"><span>Matthias Le Brun</span><strong>@bloodyowl</strong></h1></a><style data-emotion="rpcss j8u6wc">.rpcss-j8u6wc{width:0;height:20px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-j8u6wc"></div><style data-emotion="rpcss 1wi6h2w">@media (max-width: 600px){.rpcss-1wi6h2w{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}}</style><nav class="rpcss-1wi6h2w"><style data-emotion="rpcss 1t2vgdx">.rpcss-1t2vgdx{font-size:1.25rem;font-weight:700;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;color:inherit;position:relative;}.rpcss-1t2vgdx::before{content:"→ ";}</style><a class="rpcss-1t2vgdx" href="/design">design</a><a class="rpcss-1t2vgdx" href="/talks">talks</a><style data-emotion="rpcss q6ptcs">.rpcss-q6ptcs{font-size:1.25rem;font-weight:700;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;color:inherit;position:relative;}.rpcss-q6ptcs::before{content:"→ ";}.rpcss-q6ptcs::after{content:"";position:absolute;top:100%;left:20px;right:15px;height:4px;background-color:#000;transform-origin:0 0;-webkit-animation:200ms ease-in-out animation-ab7sxj;animation:200ms ease-in-out animation-ab7sxj;}</style><a class="rpcss-q6ptcs" href="/blog">blog</a></nav></header></div><style data-emotion="rpcss 60zypc">.rpcss-60zypc{-webkit-animation:300ms ease-in-out animation-zx73cm;animation:300ms ease-in-out animation-zx73cm;}</style><div class="rpcss-60zypc"><div class="rpcss-16zgwmd"><style data-emotion="rpcss n0fndg">.rpcss-n0fndg{max-width:640px;margin:20px auto;padding:0 10px;width:100%;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="rpcss-n0fndg"><style data-emotion="rpcss apovzu">.rpcss-apovzu{margin:0;font-size:48px;margin-top:50px;margin-bottom:10px;line-height:1.15;}</style><h1 class="rpcss-apovzu">Orchestrating requests at component level</h1><style data-emotion="rpcss 12xm3b2">.rpcss-12xm3b2{font-size:14px;opacity:0.5;margin-bottom:50px;}</style><div class="rpcss-12xm3b2">2019/01/24</div><style data-emotion="rpcss 18480jd">.rpcss-18480jd{margin-top:40px;font-size:20px;line-height:1.5;}.rpcss-18480jd a{color:#135EFF;}.rpcss-18480jd a:hover{color:#13A3FF;}.rpcss-18480jd img{max-width:100%;height:auto;opacity:0;-webkit-transition:300ms ease-out opacity;transition:300ms ease-out opacity;}.rpcss-18480jd pre{padding:10px 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;font-size:16px;border-radius:8px;}.rpcss-18480jd code{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:0.85em;line-height:1;}.rpcss-18480jd table{width:100%;text-align:center;}.rpcss-18480jd table thead th{background-color:#000;color:#FFF;padding:10px 0;}.rpcss-18480jd blockquote{opacity:0.6;border-left:4px solid;margin:0;padding:0 20px;}.rpcss-18480jd hr{border-color:rgba(0, 0, 0, 0.1);}</style><div class="rpcss-18480jd" role="article"><p><a href="/blog/2019-01-20-requests-with-reasonml/">In a previous article</a>, we saw how we can model request statuses in our ReasonReact component state, so that we prevent weird or impossible states.</p>
<p>Now, let's see how we can orchestrate them <strong>within</strong> our components.</p>
<p>When I was using JavaScript, I generally put all the logic involving server requests in Redux. This wasn't an obligation, but thinking in actions really helped figuring out what was happening, which was harder when calling <code>setState</code> all over the place. Using Reason, and given the evolution of React, I feel I don't need this anymore:</p>
<ul>
<li>with reducer components, <strong>thinking in actions and state</strong> can happen locally</li>
<li>props drilling is ok when backed by a <strong>static type system</strong></li>
<li>portals reduce the need for a global store that components subscribe to: you can <strong>pass the data</strong> from a component <strong>to a portal</strong> that's rendered elsewhere</li>
<li>true isolation between components makes a lot of things easier: they're <strong>reusable</strong>, their <strong>data dependencies are explicit</strong> and statically analysable, and their implementation doesn't leak to a shared store</li>
<li>reducer components embed a <a href="https://reasonml.github.io/reason-react/docs/en/state-actions-reducer#state-update-through-reducer">powerful update mechanism</a>, which is much more practical than using lifecycle or chaining promises in actions</li>
</ul>
<h2>In practice</h2>
<p>Let's say we have a component that needs to fetch a <code>User</code> and then fetch their <code>Statistics</code>, which are identified by a value we might find in the payload of the first request.</p>
<p>First, we can write an interface file (<code>.rei</code>) that lets us define what we want to expose from the implementation file we're about to do:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">type</span> state;

<span class="hljs-keyword">type</span> action;

<span class="hljs-keyword">let</span> make = array(<span class="hljs-module-identifier">React</span>.reactElement) =&gt;
  <span class="hljs-module-identifier">React</span>.component(state, <span class="hljs-module-identifier">React</span>.noRetainedProps, action);
</code></pre>
<p>This will help the compiler notice dead code, and making <code>state</code> and <code>action</code> opaque to the outside world even enables us to check if action constructors ever used, enabling the removal of entire codepaths that aren't ever executed!</p>
<p>Now for the implementation file:</p>
<p>Define the state we want:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">type</span> state = {
  user: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">User</span>.t, <span class="hljs-module-identifier">Errors</span>.t)),
  statistics: <span class="hljs-module-identifier">RequestStatus</span>.t(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Statistics</span>.t, <span class="hljs-module-identifier">Errors</span>.t)),
};
</code></pre>
<p>The actions that will occur:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">type</span> action =
  | <span class="hljs-constructor">LoadUser</span>
  | <span class="hljs-constructor">ReceiveUser</span>(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">User</span>.t, <span class="hljs-module-identifier">Errors</span>.t))
  | <span class="hljs-constructor">LoadStatistics</span>(string)
  | <span class="hljs-constructor">ReceiveStatistics</span>(<span class="hljs-module-identifier">Result</span>.t(<span class="hljs-module-identifier">Statistics</span>.t, <span class="hljs-module-identifier">Errors</span>.t));
</code></pre>
<p>Our initial state will look like this:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">let</span> initialState = {user: <span class="hljs-constructor">NotAsked</span>, statistics: <span class="hljs-constructor">NotAsked</span>};
</code></pre>
<p>So, we now have the basics! We can start writing our reducer:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">let</span> reducer = (action, state) =&gt;
  <span class="hljs-keyword">switch</span> (action) {
  <span class="hljs-comment">/* show as loading, then start the request */</span>
  | <span class="hljs-constructor">LoadUser</span> =&gt;
    <span class="hljs-constructor">UpdateWithSideEffects</span>(
      {<span class="hljs-operator">...</span>state, user: <span class="hljs-constructor">Loading</span>},
      (
        ({send}) =&gt;
          <span class="hljs-module-identifier">User</span>.get()<span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Future</span>.get(payload =&gt; send(<span class="hljs-constructor">ReceiveUser</span>(payload)))
      ),
    )
  <span class="hljs-comment">/* when we find a statisticsKey, set the user and start the second request */</span>
  | <span class="hljs-constructor">ReceiveUser</span>(<span class="hljs-constructor">Ok</span>({statisticsKey: <span class="hljs-constructor">Some</span>(key)}) <span class="hljs-keyword">as</span> user) =&gt;
    <span class="hljs-constructor">UpdateWithSideEffects</span>(
      {<span class="hljs-operator">...</span>state, user: <span class="hljs-constructor">Done</span>(user)},
      (({send}) =&gt; send(<span class="hljs-constructor">LoadStatistics</span>(key))),
    )
  <span class="hljs-comment">/* otherwise just set the user */</span>
  | <span class="hljs-constructor">ReceiveUser</span>(user) =&gt; <span class="hljs-constructor">Update</span>({<span class="hljs-operator">...</span>state, user: <span class="hljs-constructor">Done</span>(user)})
  | <span class="hljs-constructor">LoadStatistics</span>(key) =&gt;
    <span class="hljs-constructor">UpdateWithSideEffects</span>(
      {<span class="hljs-operator">...</span>state, statistics: <span class="hljs-constructor">Loading</span>},
      (
        ({send}) =&gt;
          <span class="hljs-module-identifier">Statistics</span>.get(key)
          <span class="hljs-operator">-&gt;</span><span class="hljs-module-identifier">Future</span>.get(payload =&gt; send(<span class="hljs-constructor">ReceiveStatistics</span>(payload)))
      ),
    )
  | <span class="hljs-constructor">ReceiveStatistics</span>(statistics) =&gt;
    <span class="hljs-constructor">Update</span>({<span class="hljs-operator">...</span>state, statistics: <span class="hljs-constructor">Done</span>(statistics)})
  };
</code></pre>
<p>Pattern matching our actions is really interesting here:</p>
<ul>
<li>If the <code>User</code> request fails or doesn't contain a <code>statisticsKey</code>, we don't even bother querying <code>Statistics</code>: we just store the error or user in state, and can render UI accordingly</li>
<li>We can easily see the request chaining</li>
</ul>
<p>All that's left to do is a bit of pattern matching in our render function:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">switch</span> (state.user) {
| <span class="hljs-constructor">NotAsked</span> =&gt; <span class="hljs-module-identifier">React</span>.null
| <span class="hljs-constructor">Loading</span> =&gt; &lt;<span class="hljs-module-identifier">ActivityIndicator</span> /&gt;
| <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Error</span>(error)) =&gt; &lt;<span class="hljs-module-identifier">ErrorIndicator</span> error /&gt;
| <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Ok</span>(user)) =&gt;
  &lt;&gt;
    &lt;<span class="hljs-module-identifier">UserCard</span> user /&gt;
    {
      <span class="hljs-keyword">switch</span> (state.statistics) {
      | <span class="hljs-constructor">NotAsked</span> =&gt; <span class="hljs-module-identifier">React</span>.null
      | <span class="hljs-constructor">Loading</span> =&gt; &lt;<span class="hljs-module-identifier">ActivityIndicator</span> /&gt;
      | <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Error</span>(error)) =&gt; &lt;<span class="hljs-module-identifier">ErrorIndicator</span> error /&gt;
      | <span class="hljs-constructor">Done</span>(<span class="hljs-constructor">Ok</span>(statistics)) =&gt; &lt;<span class="hljs-module-identifier">Stats</span> statistics /&gt;
      }
    }
  &lt;/&gt;
};
</code></pre>
</div><style data-emotion="rpcss 1wrrirm">.rpcss-1wrrirm{max-width:640px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:spaceBetween;-ms-flex-pack:spaceBetween;-webkit-justify-content:spaceBetween;justify-content:spaceBetween;margin:20px 0;padding:20px;border:0.5px dashed;border-radius:10px;}@media (max-width: 540px){.rpcss-1wrrirm{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-1wrrirm"><style data-emotion="rpcss 1p761yt">.rpcss-1p761yt{font-weight:900;font-size:18px;}</style><div class="rpcss-1p761yt">Liked this article?</div><div class="rpcss-klacsp"></div><style data-emotion="rpcss mumwm1">.rpcss-mumwm1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}@media (max-width: 540px){.rpcss-mumwm1{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-mumwm1"><style data-emotion="rpcss 14isay4">.rpcss-14isay4{background-color:#00aced;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:900;}.rpcss-14isay4:active{opacity:0.5;}</style><a class="rpcss-14isay4" href="https://www.twitter.com/intent/tweet?text=Orchestrating%20requests%20at%20component%20level%20from%20%40bloodyowl%20https%3A%2F%2Fbloodyowl.io%2Fblog%2F2019-01-24-orchestrating-requests-at-component-level" target="_blank">→ Share it on Twitter</a><style data-emotion="rpcss 4cf197">.rpcss-4cf197{width:10px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-4cf197"></div><style data-emotion="rpcss v8vdfl">.rpcss-v8vdfl{background-color:#ea4aaa;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:900;}.rpcss-v8vdfl:active{opacity:0.5;}</style><a class="rpcss-v8vdfl" href="https://github.com/sponsors/bloodyowl" rel="noopener" target="_blank">→ Sponsor me on GitHub</a></div></div></div></div></div><div class="rpcss-16zgwmd"><style data-emotion="rpcss 10z3agf">.rpcss-10z3agf{text-align:center;padding:10vh 0;opacity:0.5;}</style><footer class="rpcss-10z3agf">© Matthias Le Brun</footer></div></div></div><script id="initialData" type="text/data">{"lists":{"RE_PRIVATE_NONE":true},"items":{"k":"blog","v":{"k":"2019-01-24-orchestrating-requests-at-component-level","v":{"_0":{"TAG":0,"_0":{"slug":"2019-01-24-orchestrating-requests-at-component-level","filename":"2019-01-24-orchestrating-requests-at-component-level","title":"Orchestrating requests at component level","date":"Thu, 24 Jan 2019 00:00:00 GMT","draft":false,"meta":{"date":"2019-01-24T00:00:00.000Z","title":"Orchestrating requests at component level"},"body":"\u003cp>\u003ca href=\"/blog/2019-01-20-requests-with-reasonml/\">In a previous article\u003c/a>, we saw how we can model request statuses in our ReasonReact component state, so that we prevent weird or impossible states.\u003c/p>\n\u003cp>Now, let's see how we can orchestrate them \u003cstrong>within\u003c/strong> our components.\u003c/p>\n\u003cp>When I was using JavaScript, I generally put all the logic involving server requests in Redux. This wasn't an obligation, but thinking in actions really helped figuring out what was happening, which was harder when calling \u003ccode>setState\u003c/code> all over the place. Using Reason, and given the evolution of React, I feel I don't need this anymore:\u003c/p>\n\u003cul>\n\u003cli>with reducer components, \u003cstrong>thinking in actions and state\u003c/strong> can happen locally\u003c/li>\n\u003cli>props drilling is ok when backed by a \u003cstrong>static type system\u003c/strong>\u003c/li>\n\u003cli>portals reduce the need for a global store that components subscribe to: you can \u003cstrong>pass the data\u003c/strong> from a component \u003cstrong>to a portal\u003c/strong> that's rendered elsewhere\u003c/li>\n\u003cli>true isolation between components makes a lot of things easier: they're \u003cstrong>reusable\u003c/strong>, their \u003cstrong>data dependencies are explicit\u003c/strong> and statically analysable, and their implementation doesn't leak to a shared store\u003c/li>\n\u003cli>reducer components embed a \u003ca href=\"https://reasonml.github.io/reason-react/docs/en/state-actions-reducer#state-update-through-reducer\">powerful update mechanism\u003c/a>, which is much more practical than using lifecycle or chaining promises in actions\u003c/li>\n\u003c/ul>\n\u003ch2>In practice\u003c/h2>\n\u003cp>Let's say we have a component that needs to fetch a \u003ccode>User\u003c/code> and then fetch their \u003ccode>Statistics\u003c/code>, which are identified by a value we might find in the payload of the first request.\u003c/p>\n\u003cp>First, we can write an interface file (\u003ccode>.rei\u003c/code>) that lets us define what we want to expose from the implementation file we're about to do:\u003c/p>\n\u003cpre>\u003ccode class=\"hljs language-reason\">\u003cspan class=\"hljs-keyword\">type\u003c/span> state;\n\n\u003cspan class=\"hljs-keyword\">type\u003c/span> action;\n\n\u003cspan class=\"hljs-keyword\">let\u003c/span> make = array(\u003cspan class=\"hljs-module-identifier\">React\u003c/span>.reactElement) =&gt;\n  \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.component(state, \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.noRetainedProps, action);\n\u003c/code>\u003c/pre>\n\u003cp>This will help the compiler notice dead code, and making \u003ccode>state\u003c/code> and \u003ccode>action\u003c/code> opaque to the outside world even enables us to check if action constructors ever used, enabling the removal of entire codepaths that aren't ever executed!\u003c/p>\n\u003cp>Now for the implementation file:\u003c/p>\n\u003cp>Define the state we want:\u003c/p>\n\u003cpre>\u003ccode class=\"hljs language-reason\">\u003cspan class=\"hljs-keyword\">type\u003c/span> state = {\n  user: \u003cspan class=\"hljs-module-identifier\">RequestStatus\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">User\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t)),\n  statistics: \u003cspan class=\"hljs-module-identifier\">RequestStatus\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Statistics\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t)),\n};\n\u003c/code>\u003c/pre>\n\u003cp>The actions that will occur:\u003c/p>\n\u003cpre>\u003ccode class=\"hljs language-reason\">\u003cspan class=\"hljs-keyword\">type\u003c/span> action =\n  | \u003cspan class=\"hljs-constructor\">LoadUser\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">User\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t))\n  | \u003cspan class=\"hljs-constructor\">LoadStatistics\u003c/span>(string)\n  | \u003cspan class=\"hljs-constructor\">ReceiveStatistics\u003c/span>(\u003cspan class=\"hljs-module-identifier\">Result\u003c/span>.t(\u003cspan class=\"hljs-module-identifier\">Statistics\u003c/span>.t, \u003cspan class=\"hljs-module-identifier\">Errors\u003c/span>.t));\n\u003c/code>\u003c/pre>\n\u003cp>Our initial state will look like this:\u003c/p>\n\u003cpre>\u003ccode class=\"hljs language-reason\">\u003cspan class=\"hljs-keyword\">let\u003c/span> initialState = {user: \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span>, statistics: \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span>};\n\u003c/code>\u003c/pre>\n\u003cp>So, we now have the basics! We can start writing our reducer:\u003c/p>\n\u003cpre>\u003ccode class=\"hljs language-reason\">\u003cspan class=\"hljs-keyword\">let\u003c/span> reducer = (action, state) =&gt;\n  \u003cspan class=\"hljs-keyword\">switch\u003c/span> (action) {\n  \u003cspan class=\"hljs-comment\">/* show as loading, then start the request */\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">LoadUser\u003c/span> =&gt;\n    \u003cspan class=\"hljs-constructor\">UpdateWithSideEffects\u003c/span>(\n      {\u003cspan class=\"hljs-operator\">...\u003c/span>state, user: \u003cspan class=\"hljs-constructor\">Loading\u003c/span>},\n      (\n        ({send}) =&gt;\n          \u003cspan class=\"hljs-module-identifier\">User\u003c/span>.get()\u003cspan class=\"hljs-operator\">-&gt;\u003c/span>\u003cspan class=\"hljs-module-identifier\">Future\u003c/span>.get(payload =&gt; send(\u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(payload)))\n      ),\n    )\n  \u003cspan class=\"hljs-comment\">/* when we find a statisticsKey, set the user and start the second request */\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(\u003cspan class=\"hljs-constructor\">Ok\u003c/span>({statisticsKey: \u003cspan class=\"hljs-constructor\">Some\u003c/span>(key)}) \u003cspan class=\"hljs-keyword\">as\u003c/span> user) =&gt;\n    \u003cspan class=\"hljs-constructor\">UpdateWithSideEffects\u003c/span>(\n      {\u003cspan class=\"hljs-operator\">...\u003c/span>state, user: \u003cspan class=\"hljs-constructor\">Done\u003c/span>(user)},\n      (({send}) =&gt; send(\u003cspan class=\"hljs-constructor\">LoadStatistics\u003c/span>(key))),\n    )\n  \u003cspan class=\"hljs-comment\">/* otherwise just set the user */\u003c/span>\n  | \u003cspan class=\"hljs-constructor\">ReceiveUser\u003c/span>(user) =&gt; \u003cspan class=\"hljs-constructor\">Update\u003c/span>({\u003cspan class=\"hljs-operator\">...\u003c/span>state, user: \u003cspan class=\"hljs-constructor\">Done\u003c/span>(user)})\n  | \u003cspan class=\"hljs-constructor\">LoadStatistics\u003c/span>(key) =&gt;\n    \u003cspan class=\"hljs-constructor\">UpdateWithSideEffects\u003c/span>(\n      {\u003cspan class=\"hljs-operator\">...\u003c/span>state, statistics: \u003cspan class=\"hljs-constructor\">Loading\u003c/span>},\n      (\n        ({send}) =&gt;\n          \u003cspan class=\"hljs-module-identifier\">Statistics\u003c/span>.get(key)\n          \u003cspan class=\"hljs-operator\">-&gt;\u003c/span>\u003cspan class=\"hljs-module-identifier\">Future\u003c/span>.get(payload =&gt; send(\u003cspan class=\"hljs-constructor\">ReceiveStatistics\u003c/span>(payload)))\n      ),\n    )\n  | \u003cspan class=\"hljs-constructor\">ReceiveStatistics\u003c/span>(statistics) =&gt;\n    \u003cspan class=\"hljs-constructor\">Update\u003c/span>({\u003cspan class=\"hljs-operator\">...\u003c/span>state, statistics: \u003cspan class=\"hljs-constructor\">Done\u003c/span>(statistics)})\n  };\n\u003c/code>\u003c/pre>\n\u003cp>Pattern matching our actions is really interesting here:\u003c/p>\n\u003cul>\n\u003cli>If the \u003ccode>User\u003c/code> request fails or doesn't contain a \u003ccode>statisticsKey\u003c/code>, we don't even bother querying \u003ccode>Statistics\u003c/code>: we just store the error or user in state, and can render UI accordingly\u003c/li>\n\u003cli>We can easily see the request chaining\u003c/li>\n\u003c/ul>\n\u003cp>All that's left to do is a bit of pattern matching in our render function:\u003c/p>\n\u003cpre>\u003ccode class=\"hljs language-reason\">\u003cspan class=\"hljs-keyword\">switch\u003c/span> (state.user) {\n| \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span> =&gt; \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.null\n| \u003cspan class=\"hljs-constructor\">Loading\u003c/span> =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ActivityIndicator\u003c/span> /&gt;\n| \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Error\u003c/span>(error)) =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ErrorIndicator\u003c/span> error /&gt;\n| \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Ok\u003c/span>(user)) =&gt;\n  &lt;&gt;\n    &lt;\u003cspan class=\"hljs-module-identifier\">UserCard\u003c/span> user /&gt;\n    {\n      \u003cspan class=\"hljs-keyword\">switch\u003c/span> (state.statistics) {\n      | \u003cspan class=\"hljs-constructor\">NotAsked\u003c/span> =&gt; \u003cspan class=\"hljs-module-identifier\">React\u003c/span>.null\n      | \u003cspan class=\"hljs-constructor\">Loading\u003c/span> =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ActivityIndicator\u003c/span> /&gt;\n      | \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Error\u003c/span>(error)) =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">ErrorIndicator\u003c/span> error /&gt;\n      | \u003cspan class=\"hljs-constructor\">Done\u003c/span>(\u003cspan class=\"hljs-constructor\">Ok\u003c/span>(statistics)) =&gt; &lt;\u003cspan class=\"hljs-module-identifier\">Stats\u003c/span> statistics /&gt;\n      }\n    }\n  &lt;/&gt;\n};\n\u003c/code>\u003c/pre>\n"}}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"listsRequests":{"data":{"RE_PRIVATE_NONE":true}},"itemsRequests":{"data":{"RE_PRIVATE_NONE":true}}}</script><head><script defer="defer" src="/public/main.3d0b2292daa6b619865a.js"></script></head></html>