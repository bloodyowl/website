<!DOCTYPE html><html lang="en"><head><title data-react-helmet="true">An alternative migration path for ReasonReact</title><meta data-react-helmet="true" name="description" value="Front-end developer and designer. ReasonML, ReasonReact, ReactJS."/><meta data-react-helmet="true" charset="UTF-8"/><meta data-react-helmet="true" content="w75-P-0ywXWkyZvYPbkSM3VSM2hny25UrfeiWJt3B1k" name="google-site-verification"/><meta data-react-helmet="true" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" name="viewport"/><meta data-react-helmet="true" content="summary_large_image" name="twitter:card"/><meta data-react-helmet="true" content="website" property="og:type"/><meta data-react-helmet="true" content="https://bloodyowl.io/public/assets/images/share.jpg" property="og:image"/><meta data-react-helmet="true" content="https://bloodyowl.io/public/assets/images/share.jpg" name="twitter:image"/><meta data-react-helmet="true" content="@bloodyowl" name="twitter:site"/><meta data-react-helmet="true" content="1500" property="og:image:width"/><meta data-react-helmet="true" content="777" property="og:image:height"/><link data-react-helmet="true" href="/public/assets/images/favicon.png" rel="shortcut icon"/><link data-react-helmet="true" href="https://bloodyowl.io/blog/2019-04-19-an-alternative-migration-path-for-reason-react/" rel="canonical"/><style data-react-helmet="true" >@import url("//hello.myfonts.net/count/3cae5f")</style><script data-react-helmet="true" >window.beOpAsyncInit = function() {
        BeOpSDK.init({
          account: "556e1d2772a6b60100844051"
        });
        BeOpSDK.watch();
      };</script><script data-react-helmet="true" async="true" src="https://widget.beop.io/sdk.js"></script><script>window.PAGES_BOOT_MODE="hydrate";</script></head><div id="root"><style data-emotion="rpcss 13ah45v u2ep3e 956oyo">@-webkit-keyframes animation-13ah45v{50%{opacity:0.5;}}@keyframes animation-13ah45v{50%{opacity:0.5;}}@font-face{font-family:HelveticaNowDisplay;src:url("/public/assets/webfonts/regular.woff2"),url("/public/assets/webfonts/regular.woff");font-style:normal;font-weight:400;font-display:swap;}@font-face{font-family:HelveticaNowDisplay;src:url("/public/assets/webfonts/bold.woff2"),url("/public/assets/webfonts/bold.woff");font-style:normal;font-weight:700;font-display:swap;}body{padding:0;margin:0;background-color:#fff;font-family:HelveticaNowDisplay,"Helvetica Neue",Helvetica,Arial,sans-serif;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;min-height:100vh;overflow-x:hidden;}@media (prefers-color-scheme: dark){body{background-color:#222;}}#root{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}html{color:#46515b;font-size:1em;line-height:1.4;-webkit-font-smoothing:antialiased;-webkit-text-size-adjust:100%;}@media (prefers-color-scheme: dark){html{color:#e4ebee;}}*,*:before,*:after{box-sizing:border-box;}pre,.hljs{color:#abb2bf;background:#282c34;}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic;}.hljs-doctag,.hljs-keyword,.hljs-formula{color:#c678dd;}.hljs-section,.hljs-name,.hljs-selector-tag,.hljs-deletion,.hljs-subst{color:#e06c75;}.hljs-literal{color:#56b6c2;}.hljs-string,.hljs-regexp,.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string{color:#98c379;}.hljs-attr,.hljs-variable,.hljs-template-variable,.hljs-type,.hljs-selector-class,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-number{color:#d19a66;}.hljs-symbol,.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-title{color:#61aeee;}.hljs-built_in,.hljs-title.class_,.hljs-class .hljs-title{color:#e6c07b;}.hljs-emphasis{font-style:italic;}.hljs-strong{font-weight:bold;}.hljs-link{-webkit-text-decoration:underline;text-decoration:underline;}</style><style data-emotion="rpcss 1lm8k0f">.rpcss-1lm8k0f{min-height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;}</style><div class="rpcss-1lm8k0f"><style data-emotion="rpcss 1kq07em">.rpcss-1kq07em{background-color:#E4EBEE;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;padding:0 env(safe-area-inset-right) 0 env(safe-area-inset-left);}@media (prefers-color-scheme: dark){.rpcss-1kq07em{background-color:#111;}}@media (max-width: 620px){.rpcss-1kq07em{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-1kq07em"><style data-emotion="rpcss 1ku00uy">.rpcss-1ku00uy{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;color:#46515B;-webkit-text-decoration:none;text-decoration:none;}@media (prefers-color-scheme: dark){.rpcss-1ku00uy{color:#E4EBEE;}}</style><a class="rpcss-1ku00uy" href="/"><style data-emotion="rpcss 19jaiin">.rpcss-19jaiin{margin-right:10px;margin-left:20px;-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;}</style><img class="rpcss-19jaiin" alt="" height="32" src="/public/assets/images/owl.svg" width="32"/><style data-emotion="rpcss 16ucz1n">.rpcss-16ucz1n{padding:20px 20px 23px 0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div aria-level="1" class="rpcss-16ucz1n" role="heading"><style data-emotion="rpcss a6owh4">.rpcss-a6owh4{font-weight:bold;margin-right:10px;white-space:nowrap;}</style><div class="rpcss-a6owh4">Matthias Le Brun</div><div>@bloodyowl</div></div></a><style data-emotion="rpcss 1qpr5ai">.rpcss-1qpr5ai{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}@media (max-width: 620px){.rpcss-1qpr5ai{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;background-color:#D4E1E6;}}@media (max-width: 620px) and (prefers-color-scheme: dark){.rpcss-1qpr5ai{background-color:#111;}}</style><div class="rpcss-1qpr5ai"><style data-emotion="rpcss 5uxyjd">.rpcss-5uxyjd{padding:20px 20px 23px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-text-decoration:none;text-decoration:none;color:#46515B;text-align:center;font-weight:bold;}@media (prefers-color-scheme: dark){.rpcss-5uxyjd{color:#E4EBEE;}}@media (max-width: 620px){.rpcss-5uxyjd{-webkit-flex-basis:25%;-ms-flex-preferred-size:25%;flex-basis:25%;padding:10px 10px 13px;}}</style><a class="rpcss-5uxyjd" href="/blog/">Blog</a><style data-emotion="rpcss yvhxql">.rpcss-yvhxql{padding:20px 20px 23px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-text-decoration:none;text-decoration:none;color:#46515B;text-align:center;}@media (prefers-color-scheme: dark){.rpcss-yvhxql{color:#E4EBEE;}}@media (max-width: 620px){.rpcss-yvhxql{-webkit-flex-basis:25%;-ms-flex-preferred-size:25%;flex-basis:25%;padding:10px 10px 13px;}}</style><a class="rpcss-yvhxql" href="https://twitter.com/bloodyowl">Twitter</a><a class="rpcss-yvhxql" href="https://github.com/bloodyowl">GitHub</a><a class="rpcss-yvhxql" href="https://www.linkedin.com/in/bloodyowl">LinkedIn</a></div></div><style data-emotion="rpcss n63pef">.rpcss-n63pef{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:stretch;-webkit-box-align:stretch;-ms-flex-align:stretch;align-items:stretch;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);}</style><div class="rpcss-n63pef"><style data-emotion="rpcss n0fndg">.rpcss-n0fndg{max-width:640px;margin:20px auto;padding:0 10px;width:100%;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}</style><div class="rpcss-n0fndg"><style data-emotion="rpcss apovzu">.rpcss-apovzu{margin:0;font-size:48px;margin-top:50px;margin-bottom:10px;line-height:1.15;}</style><h1 class="rpcss-apovzu">An alternative migration path for ReasonReact</h1><style data-emotion="rpcss 12xm3b2">.rpcss-12xm3b2{font-size:14px;opacity:0.5;margin-bottom:50px;}</style><div class="rpcss-12xm3b2">2019/04/19</div><style data-emotion="rpcss 23aks3">.rpcss-23aks3{margin-top:40px;font-size:20px;line-height:1.5;}.rpcss-23aks3 a{color:#135EFF;}.rpcss-23aks3 a:hover{color:#13A3FF;}@media (prefers-color-scheme: dark){.rpcss-23aks3 a{color:#13A3FF;}}.rpcss-23aks3 img{max-width:100%;height:auto;opacity:0;-webkit-transition:300ms ease-out opacity;transition:300ms ease-out opacity;}.rpcss-23aks3 pre{padding:10px 20px;overflow-x:auto;-webkit-overflow-scrolling:touch;font-size:16px;border-radius:8px;}.rpcss-23aks3 code{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,Courier,monospace;font-size:0.85em;line-height:1;}.rpcss-23aks3 table{width:100%;text-align:center;}.rpcss-23aks3 table thead th{background-color:#E4EBEE;padding:10px 0;}@media (prefers-color-scheme: dark){.rpcss-23aks3 table thead th{background-color:#111;}}.rpcss-23aks3 blockquote{opacity:0.6;border-left:4px solid #46515B;margin:0;padding:0 20px;}.rpcss-23aks3 hr{border-color:rgba(0, 0, 0, 0.1);}@media (prefers-color-scheme: dark){.rpcss-23aks3 hr{border-color:rgba(255, 255, 255, 0.1);}}</style><div class="rpcss-23aks3" role="article"><p><a href="https://github.com/bloodyowl/upgrade-reason-react-esy">tl;dr</a></p>
<h2>Why the new API?</h2>
<p>ReasonReact 0.7.0 came out recently, with a really nice set of features:</p>
<ul>
<li>A closer model from the official ReactJS API</li>
<li>Hooks</li>
<li>Zero-cost bindings</li>
</ul>
<p>From some time now though, ReasonReact leverages function <strong>named parameters</strong> which provides a really nice set of features natively, such as defaults, optional parameters and ability to pattern match values.</p>
<p>This was possible through a JSX transformation and some bindings that would apply these arguments at call site, and return a new version of the component whenever called.</p>
<p>A component would look like this:</p>
<pre><code class="hljs language-reason"><span class="hljs-comment">/* MyComp.re */</span>
<span class="hljs-keyword">let</span> make = (~param1, ~param2, children) =&gt; {
  <span class="hljs-operator">...</span>component,
  render: _ =&gt; &lt;div /&gt;
};
</code></pre>
<p>And the call site <code>&lt;MyComp param1 param2 /&gt;</code> would desugar to something like this:</p>
<pre><code class="hljs language-reason"><span class="hljs-module-identifier">React</span>.element(~key, ~ref, <span class="hljs-module-identifier">MyComp</span>.make(~param1, ~param2, <span class="hljs-literal">[|</span><span class="hljs-literal">|]</span> <span class="hljs-comment">/* children*/</span>))
</code></pre>
<p>and would reuse the previous component through some magic in <code>React.element</code>, by keeping a reference to an actual React component class that'd render using the component spec it received.</p>
<p>This magic worked while relying on the class-based API, because it wouldn't matter that the <code>make</code> function had a different identity at each run, as <code>React.createElement</code> effectively received class.</p>
<p>With function component though, the story is a little different: <strong>function identity matters</strong> here. It'd be possible to wrap every component with a higher order one, but that wouldn't make for a good developer experience, and would possibly be a little heavier to run.</p>
<p>The obvious choice would then be to start using directly the JS Object as props, just like in ReactJS. However, that wouldn't let us benefit from the really nice features function params give us (defaults, optionals, pattern matching…).</p>
<p>Therefore was introduced the <code>[@react.component]</code> attribute. What it does in summary:</p>
<pre><code class="hljs language-reason"><span class="hljs-attribute">[@react.component]</span>
<span class="hljs-keyword">let</span> make = (~prop1, ~prop2, ()) =&gt; {
  &lt;div /&gt;
};
</code></pre>
<p>is that it leverages <code>[@bs.obj]</code> (zero-cost except in edge-cases) and roughly generates the following:</p>
<pre><code class="hljs language-reason"><span class="hljs-keyword">let</span> makeProps: (~prop1, ~prop2, unit) =&gt;
  {. <span class="hljs-string">&quot;prop1&quot;</span>: &#x27;a, <span class="hljs-string">&quot;prop2&quot;</span>: &#x27;b};

<span class="hljs-keyword">let</span> make: ({. <span class="hljs-string">&quot;prop1&quot;</span>: &#x27;a, <span class="hljs-string">&quot;prop2&quot;</span>: &#x27;b}) =&gt;
  <span class="hljs-module-identifier">React</span>.element;
</code></pre>
<p>This way, the new JSX API can simply desugar to:</p>
<pre><code class="hljs language-reason"><span class="hljs-module-identifier">React</span>.createElement(<span class="hljs-module-identifier">MyComp</span>.make, <span class="hljs-module-identifier">MyComp</span>.makeProps(~prop1, ~prop2, ()));
</code></pre>
<p>which is, thanks to BuckleScript, compiled to:</p>
<pre><code class="hljs language-js">React.createElement(MyComp.make, { <span class="hljs-attr">prop1</span>: prop1, <span class="hljs-attr">prop2</span>: prop2 });
</code></pre>
<h2>Planning the migration</h2>
<p>Of course, changing the way JSX works must have been a tough call for the ReasonReact team, as the API has been pretty stable for some time before that, but I'm sure the benefits in the long run will be really important.</p>
<p>Now, how do we handle the transition?</p>
<p>The original plan <a href="https://twitter.com/rickyvetter">Ricky Vetter</a> had was to create a hook that'd wrap the old component specs and act as a compatibility API. In the end, he assessed that this way wouldn't be able to provide a script that'd be safe enough for people to use and provided a different kind of migration path.</p>
<p>I really found the idea to be elegant though, and if I ever released it and it was a bit rough around the edges, people wouldn't be as mad as they would've been with an official migration.</p>
<p>So I went on from Ricky's work, patched a few things and made <a href="https://github.com/bloodyowl/reason-react-compat">reason-react-compat</a>. The main concept is that it replicates the lifecycle using hooks. It has of course some small issues, such as retriggering a render each time you send a side-effect and might be a little aggressive on <code>willReceiveProps</code> (treat it as it was <code>getDerivedStateFromProps</code>). Other than that it should mostly work, and these are tradeoffs I'm personnaly willing to make for my own codebase.</p>
<p>After having that, I wanted to make an automated codemod, and ended up with the following list of what it needed to do (lots of points here are motivated by how my internal codebase is made):</p>
<ul>
<li>Add <code>[@react.component]</code> to <code>make</code> functions returning a <code>component</code> in implementation</li>
<li>Wrap these components with <code>ReactCompat.useRecordApi</code></li>
<li>Turn ignored <code>children</code> (starting with <code>_</code>) to <code>unit</code> in implementation</li>
<li>Turn used <code>children</code> into a named parameter and append a <code>unit</code> parameter in implementation</li>
<li>Use <code>React.Children.toArray</code> at the top of every make function's body that use them as such (children type isn't guaranteed to be <code>array(React.element)</code> anymore)</li>
<li>Add <code>[@react.component]</code> to <code>make</code> functions returning a <code>component</code> in interfaces</li>
<li>Turn <code>array(React.element)</code> into <code>React.element</code> for children in interfaces</li>
<li>Turn <code>React.component(a, b, c)</code> and <code>React.componentSpec(a, a, b, b, c, c)</code> into <code>React.element</code> in interfaces' <code>make</code> return value</li>
<li>Handle all of the above for nested modules and functors</li>
</ul>
<p>So I forked Cheng Lou's <a href="https://github.com/chenglou/upgrade-reason-react">upgrade-reason-react</a> and started working with the AST (it's really fun, you should try it!) and ended up with a decent transformation (at least for my test cases). If you're interested, <a href="https://github.com/bloodyowl/upgrade-reason-react-esy">the above transformation script is available on GitHub</a>, you can check the input in <code>test/cases</code> and output in <code>output/test/cases</code>.</p>
<p>While I was at it, I also released a <code>useReducer</code> hook that allows returning an update (<code>NoUpdate</code>, <code>Update</code>, <code>UpdateWithSideEffects</code> or <code>SideEffects</code>) because I find that to be <a href="/blog/2019-01-24-orchestrating-requests-at-component-level/">one of the best way to orchestrate things in your components</a>, you can check it out in <a href="https://github.com/bloodyowl/reason-react-update">its repository</a>.</p>
<p>If you want to try these, be sure to ping me in Twitter, Discord or GitHub if you run into any issue!</p>
</div><style data-emotion="rpcss 1ioslcv">.rpcss-1ioslcv{max-width:640px;width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:spaceBetween;-ms-flex-pack:spaceBetween;-webkit-justify-content:spaceBetween;justify-content:spaceBetween;margin:20px 0;padding:20px;background-color:#FFF;border-radius:10px;box-shadow:0 15px 15px 5px rgba(0, 0, 0, 0.2),0 0 0 1px rgba(0, 0, 0, 0.1);}@media (prefers-color-scheme: dark){.rpcss-1ioslcv{background-color:#111;}}@media (max-width: 540px){.rpcss-1ioslcv{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-1ioslcv"><style data-emotion="rpcss 1p761yt">.rpcss-1p761yt{font-weight:900;font-size:18px;}</style><div class="rpcss-1p761yt">Liked this article?</div><style data-emotion="rpcss klacsp">.rpcss-klacsp{width:0;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-klacsp"></div><style data-emotion="rpcss mumwm1">.rpcss-mumwm1{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}@media (max-width: 540px){.rpcss-mumwm1{-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}}</style><div class="rpcss-mumwm1"><style data-emotion="rpcss 14isay4">.rpcss-14isay4{background-color:#00aced;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:900;}.rpcss-14isay4:active{opacity:0.5;}</style><a class="rpcss-14isay4" href="https://www.twitter.com/intent/tweet?text=An%20alternative%20migration%20path%20for%20ReasonReact%20from%20%40bloodyowl%20https%3A%2F%2Fbloodyowl.io%2Fblog%2F2019-04-19-an-alternative-migration-path-for-reason-react" target="_blank">→ Share it on Twitter</a><style data-emotion="rpcss 4cf197">.rpcss-4cf197{width:10px;height:10px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}</style><div class="rpcss-4cf197"></div><style data-emotion="rpcss v8vdfl">.rpcss-v8vdfl{background-color:#ea4aaa;color:#fff;padding:10px 20px;-webkit-text-decoration:none;text-decoration:none;border-radius:5px;font-weight:900;}.rpcss-v8vdfl:active{opacity:0.5;}</style><a class="rpcss-v8vdfl" href="https://github.com/sponsors/bloodyowl" rel="noopener" target="_blank">→ Sponsor me on GitHub</a></div></div><style data-emotion="rpcss sq4ju6">.rpcss-sq4ju6{padding:10px 0;}</style><div class="rpcss-sq4ju6"><div class="BeOpWidget"></div></div></div></div><style data-emotion="rpcss 7az74g">.rpcss-7az74g{background-color:#46515B;color:#fff;text-align:center;padding:20px;font-size:14px;}@media (prefers-color-scheme: dark){.rpcss-7az74g{background-color:#000;}}</style><div class="rpcss-7az74g"><div>Copyright 2021 - Matthias Le Brun</div><div><style data-emotion="rpcss 1tzeee1">.rpcss-1tzeee1{opacity:0.5;}</style><span class="rpcss-1tzeee1">Do you like the content? </span><style data-emotion="rpcss 1d5fxl9">.rpcss-1d5fxl9{color:#EC8AC5;}.rpcss-1d5fxl9:hover{color:#F9BDE1;}</style><a class="rpcss-1d5fxl9" href="https://github.com/sponsors/bloodyowl"> Sponsor me on GitHub</a></div></div></div></div><script id="initialData" type="text/data">{"lists":{"RE_PRIVATE_NONE":true},"items":{"k":"blog","v":{"k":"2019-04-19-an-alternative-migration-path-for-reason-react","v":{"_0":{"TAG":0,"_0":{"slug":"2019-04-19-an-alternative-migration-path-for-reason-react","filename":"2019-04-19-an-alternative-migration-path-for-reason-react","title":"An alternative migration path for ReasonReact","date":"Fri, 19 Apr 2019 00:00:00 GMT","draft":false,"meta":{"date":"2019-04-19T00:00:00.000Z","title":"An alternative migration path for ReasonReact"},"body":"<p><a href=\"https://github.com/bloodyowl/upgrade-reason-react-esy\">tl;dr</a></p>\n<h2>Why the new API?</h2>\n<p>ReasonReact 0.7.0 came out recently, with a really nice set of features:</p>\n<ul>\n<li>A closer model from the official ReactJS API</li>\n<li>Hooks</li>\n<li>Zero-cost bindings</li>\n</ul>\n<p>From some time now though, ReasonReact leverages function <strong>named parameters</strong> which provides a really nice set of features natively, such as defaults, optional parameters and ability to pattern match values.</p>\n<p>This was possible through a JSX transformation and some bindings that would apply these arguments at call site, and return a new version of the component whenever called.</p>\n<p>A component would look like this:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-comment\">/* MyComp.re */</span>\n<span class=\"hljs-keyword\">let</span> make = (~param1, ~param2, children) =&gt; {\n  <span class=\"hljs-operator\">...</span>component,\n  render: _ =&gt; &lt;div /&gt;\n};\n</code></pre>\n<p>And the call site <code>&lt;MyComp param1 param2 /&gt;</code> would desugar to something like this:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-module-identifier\">React</span>.element(~key, ~ref, <span class=\"hljs-module-identifier\">MyComp</span>.make(~param1, ~param2, <span class=\"hljs-literal\">[|</span><span class=\"hljs-literal\">|]</span> <span class=\"hljs-comment\">/* children*/</span>))\n</code></pre>\n<p>and would reuse the previous component through some magic in <code>React.element</code>, by keeping a reference to an actual React component class that'd render using the component spec it received.</p>\n<p>This magic worked while relying on the class-based API, because it wouldn't matter that the <code>make</code> function had a different identity at each run, as <code>React.createElement</code> effectively received class.</p>\n<p>With function component though, the story is a little different: <strong>function identity matters</strong> here. It'd be possible to wrap every component with a higher order one, but that wouldn't make for a good developer experience, and would possibly be a little heavier to run.</p>\n<p>The obvious choice would then be to start using directly the JS Object as props, just like in ReactJS. However, that wouldn't let us benefit from the really nice features function params give us (defaults, optionals, pattern matching…).</p>\n<p>Therefore was introduced the <code>[@react.component]</code> attribute. What it does in summary:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-attribute\">[@react.component]</span>\n<span class=\"hljs-keyword\">let</span> make = (~prop1, ~prop2, ()) =&gt; {\n  &lt;div /&gt;\n};\n</code></pre>\n<p>is that it leverages <code>[@bs.obj]</code> (zero-cost except in edge-cases) and roughly generates the following:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-keyword\">let</span> makeProps: (~prop1, ~prop2, unit) =&gt;\n  {. <span class=\"hljs-string\">&quot;prop1&quot;</span>: &#x27;a, <span class=\"hljs-string\">&quot;prop2&quot;</span>: &#x27;b};\n\n<span class=\"hljs-keyword\">let</span> make: ({. <span class=\"hljs-string\">&quot;prop1&quot;</span>: &#x27;a, <span class=\"hljs-string\">&quot;prop2&quot;</span>: &#x27;b}) =&gt;\n  <span class=\"hljs-module-identifier\">React</span>.element;\n</code></pre>\n<p>This way, the new JSX API can simply desugar to:</p>\n<pre><code class=\"hljs language-reason\"><span class=\"hljs-module-identifier\">React</span>.createElement(<span class=\"hljs-module-identifier\">MyComp</span>.make, <span class=\"hljs-module-identifier\">MyComp</span>.makeProps(~prop1, ~prop2, ()));\n</code></pre>\n<p>which is, thanks to BuckleScript, compiled to:</p>\n<pre><code class=\"hljs language-js\">React.createElement(MyComp.make, { <span class=\"hljs-attr\">prop1</span>: prop1, <span class=\"hljs-attr\">prop2</span>: prop2 });\n</code></pre>\n<h2>Planning the migration</h2>\n<p>Of course, changing the way JSX works must have been a tough call for the ReasonReact team, as the API has been pretty stable for some time before that, but I'm sure the benefits in the long run will be really important.</p>\n<p>Now, how do we handle the transition?</p>\n<p>The original plan <a href=\"https://twitter.com/rickyvetter\">Ricky Vetter</a> had was to create a hook that'd wrap the old component specs and act as a compatibility API. In the end, he assessed that this way wouldn't be able to provide a script that'd be safe enough for people to use and provided a different kind of migration path.</p>\n<p>I really found the idea to be elegant though, and if I ever released it and it was a bit rough around the edges, people wouldn't be as mad as they would've been with an official migration.</p>\n<p>So I went on from Ricky's work, patched a few things and made <a href=\"https://github.com/bloodyowl/reason-react-compat\">reason-react-compat</a>. The main concept is that it replicates the lifecycle using hooks. It has of course some small issues, such as retriggering a render each time you send a side-effect and might be a little aggressive on <code>willReceiveProps</code> (treat it as it was <code>getDerivedStateFromProps</code>). Other than that it should mostly work, and these are tradeoffs I'm personnaly willing to make for my own codebase.</p>\n<p>After having that, I wanted to make an automated codemod, and ended up with the following list of what it needed to do (lots of points here are motivated by how my internal codebase is made):</p>\n<ul>\n<li>Add <code>[@react.component]</code> to <code>make</code> functions returning a <code>component</code> in implementation</li>\n<li>Wrap these components with <code>ReactCompat.useRecordApi</code></li>\n<li>Turn ignored <code>children</code> (starting with <code>_</code>) to <code>unit</code> in implementation</li>\n<li>Turn used <code>children</code> into a named parameter and append a <code>unit</code> parameter in implementation</li>\n<li>Use <code>React.Children.toArray</code> at the top of every make function's body that use them as such (children type isn't guaranteed to be <code>array(React.element)</code> anymore)</li>\n<li>Add <code>[@react.component]</code> to <code>make</code> functions returning a <code>component</code> in interfaces</li>\n<li>Turn <code>array(React.element)</code> into <code>React.element</code> for children in interfaces</li>\n<li>Turn <code>React.component(a, b, c)</code> and <code>React.componentSpec(a, a, b, b, c, c)</code> into <code>React.element</code> in interfaces' <code>make</code> return value</li>\n<li>Handle all of the above for nested modules and functors</li>\n</ul>\n<p>So I forked Cheng Lou's <a href=\"https://github.com/chenglou/upgrade-reason-react\">upgrade-reason-react</a> and started working with the AST (it's really fun, you should try it!) and ended up with a decent transformation (at least for my test cases). If you're interested, <a href=\"https://github.com/bloodyowl/upgrade-reason-react-esy\">the above transformation script is available on GitHub</a>, you can check the input in <code>test/cases</code> and output in <code>output/test/cases</code>.</p>\n<p>While I was at it, I also released a <code>useReducer</code> hook that allows returning an update (<code>NoUpdate</code>, <code>Update</code>, <code>UpdateWithSideEffects</code> or <code>SideEffects</code>) because I find that to be <a href=\"/blog/2019-01-24-orchestrating-requests-at-component-level/\">one of the best way to orchestrate things in your components</a>, you can check it out in <a href=\"https://github.com/bloodyowl/reason-react-update\">its repository</a>.</p>\n<p>If you want to try these, be sure to ping me in Twitter, Discord or GitHub if you run into any issue!</p>\n"}}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"h":1,"l":{"RE_PRIVATE_NONE":true},"r":{"RE_PRIVATE_NONE":true}},"listsRequests":{"data":{"RE_PRIVATE_NONE":true}},"itemsRequests":{"data":{"RE_PRIVATE_NONE":true}}}</script><head><script defer="defer" src="/public/main.a2199c734b7c52fff8dc.js"></script></head></html>